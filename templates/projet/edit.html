{% extends "base.html" %}

{% block title %}Modifier {{ projet.nom }} - KUNDA{% endblock %}
{% block page_title %}Modifier le Projet{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white shadow-sm rounded-lg border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Modifier les informations du projet</h3>
                    <p class="mt-1 text-sm text-gray-500">Modifiez les informations du projet "{{ projet.nom }}"</p>
                </div>
                <div class="flex items-center space-x-3">
                    <a href="{{ url_for('projet_detail', id=projet.id) }}" 
                       class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Retour aux détails
                    </a>
                    <a href="{{ url_for('projet_list') }}" 
                       class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        <i class="fas fa-list mr-2"></i>
                        Liste des projets
                    </a>
                </div>
            </div>
        </div>

        <form method="POST" class="px-6 py-6 space-y-6" x-data="projetEditForm()">
            <!-- Project Basic Information -->
            <div class="grid grid-cols-1 gap-6">
                <div>
                    <label for="nom" class="block text-sm font-medium text-gray-700 mb-1">
                        Nom du projet <span class="text-red-500">*</span>
                    </label>
                    <input type="text" 
                           name="nom" 
                           id="nom" 
                           value="{{ projet.nom }}"
                           required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-300"
                           placeholder="Nom du projet">
                </div>

                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">
                        Description
                    </label>
                    <textarea name="description" 
                              id="description" 
                              rows="4"
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-300"
                              placeholder="Description détaillée du projet...">{{ projet.description or '' }}</textarea>
                </div>
            </div>

            <!-- Project Details -->
            <div class="border-t border-gray-200 pt-6">
                <h4 class="text-lg font-medium text-gray-900 mb-4">Détails du projet</h4>
                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
                    <div>
                        <label for="departement" class="block text-sm font-medium text-gray-700 mb-1">
                            Département <span class="text-red-500">*</span>
                        </label>
                        <select name="departement" 
                                id="departement" 
                                required
                                class="block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-300">
                            <option value="">Sélectionner un département</option>
                            <option value="Direction" {% if projet.departement == 'Direction' %}selected{% endif %}>Direction</option>
                            <option value="Trading" {% if projet.departement == 'Trading' %}selected{% endif %}>Trading</option>
                            <option value="Academy" {% if projet.departement == 'Academy' %}selected{% endif %}>Academy</option>
                            <option value="Digital" {% if projet.departement == 'Digital' %}selected{% endif %}>Digital</option>
                        </select>
                    </div>

                    <div>
                        <label for="statut" class="block text-sm font-medium text-gray-700 mb-1">
                            Statut <span class="text-red-500">*</span>
                        </label>
                        <select name="statut" 
                                id="statut" 
                                required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-300">
                            <option value="">Sélectionner un statut</option>
                            <option value="En attente" {% if projet.statut == 'En attente' %}selected{% endif %}>En attente</option>
                            <option value="En cours" {% if projet.statut == 'En cours' %}selected{% endif %}>En cours</option>
                            <option value="Terminé" {% if projet.statut == 'Terminé' %}selected{% endif %}>Terminé</option>
                            <option value="Annulé" {% if projet.statut == 'Annulé' %}selected{% endif %}>Annulé</option>
                        </select>
                    </div>

                    <div>
                        <label for="budget" class="block text-sm font-medium text-gray-700 mb-1">
                            Budget (FCFA)
                        </label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-coins text-gray-400"></i>
                            </div>
                            <input type="number" 
                                   name="budget" 
                                   id="budget"
                                   value="{{ projet.budget or '' }}"
                                   step="1000"
                                   min="0"
                                   class="block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-300 pl-10"
                                   placeholder="0">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dates -->
            <div class="border-t border-gray-200 pt-6">
                <h4 class="text-lg font-medium text-gray-900 mb-4">Planning du projet</h4>
                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                    <div>
                        <label for="date_debut" class="block text-sm font-medium text-gray-700 mb-1">
                            Date de début <span class="text-red-500">*</span>
                        </label>
                        <input type="date" 
                               name="date_debut" 
                               id="date_debut" 
                               value="{{ projet.date_debut.strftime('%Y-%m-%d') if projet.date_debut else '' }}"
                               required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-300"> 
                    </div>
                    <div>
                        <label for="date_fin" class="block text-sm font-medium text-gray-700 mb-1">
                            Date de fin prévue
                        </label>
                        <input type="date" 
                               name="date_fin" 
                               id="date_fin"
                               value="{{ projet.date_fin.strftime('%Y-%m-%d') if projet.date_fin else '' }}"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all duration-300">
                        <p class="mt-1 text-sm text-gray-500">Laissez vide si la date de fin n'est pas encore définie</p>
                    </div>
                </div>
            </div>

            <!-- Current Status Alert -->
            <div class="border-t border-gray-200 pt-6">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle text-blue-400"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-blue-800">
                                Statut actuel du projet
                            </h3>
                            <div class="mt-2 text-sm text-blue-700">
                                <p>Ce projet est actuellement en statut : 
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                        {% if projet.statut == 'En cours' %}bg-blue-100 text-blue-800
                                        {% elif projet.statut == 'Terminé' %}bg-green-100 text-green-800
                                        {% elif projet.statut == 'En attente' %}bg-yellow-100 text-yellow-800
                                        {% elif projet.statut == 'Annulé' %}bg-red-100 text-red-800
                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {{ projet.statut }}
                                    </span>
                                </p>
                                {% if projet.date_debut %}
                                <p class="mt-1">
                                    Créé le {{ projet.date_debut.strftime('%d/%m/%Y') }}
                                    ({{ (datetime.now().date() - projet.date_debut).days }} jours)
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="pt-6 flex items-center justify-between space-x-4">
                <div class="flex items-center space-x-4">
                    <button type="submit" 
                            class="inline-flex justify-center px-6 py-3 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-300"
                            @click="loading = true">
                        <i class="fas fa-save mr-2"></i>
                        <span x-show="!loading">Enregistrer les modifications</span>
                        <span x-show="loading" class="flex items-center">
                            <i class="fas fa-spinner fa-spin mr-2"></i>
                            Enregistrement...
                        </span>
                    </button>
                    
                    <a href="{{ url_for('projet_detail', id=projet.id) }}" 
                       class="inline-flex justify-center px-6 py-3 border border-gray-300 shadow-sm text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Annuler
                    </a>
                </div>

                <!-- Danger Zone -->
                <div x-data="{ showDangerZone: false }">
                    <button type="button" 
                            @click="showDangerZone = !showDangerZone"
                            class="inline-flex items-center px-4 py-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Actions dangereuses
                    </button>
                    
                    <div x-show="showDangerZone" 
                         x-transition:enter="transition ease-out duration-300"
                         x-transition:enter-start="opacity-0 transform scale-95"
                         x-transition:enter-end="opacity-100 transform scale-100"
                         class="fixed inset-0 z-50 overflow-y-auto"
                         style="display: none;">
                        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showDangerZone = false"></div>
                            
                            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                    <div class="sm:flex sm:items-start">
                                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                                            <i class="fas fa-exclamation-triangle text-red-600"></i>
                                        </div>
                                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                                            <h3 class="text-lg leading-6 font-medium text-gray-900">Supprimer le projet</h3>
                                            <div class="mt-2">
                                                <p class="text-sm text-gray-500">
                                                    Êtes-vous sûr de vouloir supprimer le projet "{{ projet.nom }}" ? 
                                                    Cette action est irréversible et supprimera toutes les données associées.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                    <form action="{{ url_for('projet_delete', id=projet.id) }}" method="POST" class="inline">
                                        <button type="submit" 
                                                class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                                            Supprimer définitivement
                                        </button>
                                    </form>
                                    <button type="button" 
                                            @click="showDangerZone = false"
                                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                        Annuler
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function projetEditForm() {
        return {
            loading: false,
            validateDates() {
                const dateDebut = document.getElementById('date_debut').value;
                const dateFin = document.getElementById('date_fin').value;
                
                if (dateDebut && dateFin && dateDebut > dateFin) {
                    alert('La date de fin doit être postérieure à la date de début');
                    return false;
                }
                return true;
            },
            submitForm(event) {
                if (!this.validateDates()) {
                    event.preventDefault();
                    return;
                }
                this.loading = true;
            }
        }
    }

    // Date validation
    document.getElementById('date_fin').addEventListener('change', function() {
        const dateDebut = document.getElementById('date_debut').value;
        const dateFin = this.value;
        
        if (dateDebut && dateFin && dateDebut > dateFin) {
            this.setCustomValidity('La date de fin doit être postérieure à la date de début');
        } else {
            this.setCustomValidity('');
        }
    });

    document.getElementById('date_debut').addEventListener('change', function() {
        const dateDebut = this.value;
        const dateFin = document.getElementById('date_fin').value;
        
        if (dateDebut && dateFin && dateDebut > dateFin) {
            document.getElementById('date_fin').setCustomValidity('La date de fin doit être postérieure à la date de début');
        } else {
            document.getElementById('date_fin').setCustomValidity('');
        }
    });

    // Auto-save draft (optional feature)
    let autoSaveTimeout;
    function autoSave() {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
            // Could implement auto-save functionality here
            console.log('Auto-save triggered');
        }, 30000); // Auto-save every 30 seconds
    }

    // Trigger auto-save on form changes
    document.querySelectorAll('input, textarea, select').forEach(element => {
        element.addEventListener('change', autoSave);
        element.addEventListener('input', autoSave);
    });
</script>
{% endblock %}